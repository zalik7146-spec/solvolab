<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Solvo</title>
  <meta name="description" content="Solvo v5 — философия + планирование. Мини-куб, вертикальные блоки, стеклянный дизайн.">

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

  <!-- React UMD + Babel for JSX -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <style>
    :root{
      --bg:#090e14; --fg:#eef3fa; --muted:#aab3bf;
      --glass: rgba(255,255,255,.08); --border: rgba(255,255,255,.12);
      --acc1:#7dd3fc; --acc2:#a78bfa; --acc3:#34d399; --acc4:#f472b6; --gold:#f59e0b;
      --shadow: 0 12px 50px rgba(0,0,0,.45);
      --glow: radial-gradient(900px 520px at 10% -10%, rgba(125,211,252,.16), transparent 60%),
              radial-gradient(820px 520px at 120% 6%, rgba(167,139,250,.14), transparent 60%),
              radial-gradient(700px 420px at 50% 120%, rgba(244,114,182,.12), transparent 60%);
    }
    *{box-sizing:border-box}
    html,body,#root{height:100%}
    body{
      margin:0; color:var(--fg); background: var(--glow), var(--bg);
      font: 17px/1.45 Inter, -apple-system, system-ui, "SF Pro Text", "Segoe UI", Roboto, Arial, sans-serif;
      -webkit-font-smoothing: antialiased; -webkit-text-size-adjust: 100%; -webkit-tap-highlight-color: transparent;
      overscroll-behavior: none;
    }
    a{color:inherit; text-decoration:none} button{font:inherit}

    /* Центрированная «рамка» телефона */
    .frame{
      width:100%; max-width:430px; margin:0 auto;
      height:100svh; height:100dvh;
      padding: calc(env(safe-area-inset-top,0) + 14px) 14px calc(env(safe-area-inset-bottom,0) + 14px);
      position:relative;
    }

    /* -------- Лендинг (вертикальные блоки) -------- */
    .landing{
      height:100%; display:grid; grid-template-rows:auto 1fr;
    }
    .scroll{height:100%; overflow:auto; scroll-snap-type: y mandatory; gap:18px; display:flex; flex-direction:column; padding-bottom:8px}
    .section{
      scroll-snap-align: start; border:1px solid var(--border); border-radius:18px; background:var(--glass);
      box-shadow: var(--shadow); padding:16px; backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
    }
    .section.small{min-height: 28svh} .section.medium{min-height: 46svh}
    .muted{color:var(--muted); font-size:13px}

    h1{font-size:42px; line-height:1.1; margin:0}
    h2{font-size:26px; margin:0}
    h3{font-size:16px; margin:0}

    .topbar{display:flex; align-items:center; gap:10px; margin-bottom:12px}
    .brand{font-weight:800}
    .btn{border:1px solid var(--border); border-radius:12px; padding:12px 14px; background:linear-gradient(90deg,var(--acc3),var(--acc2)); color:#08121a; font-weight:800; letter-spacing:.02em; box-shadow:var(--shadow); cursor:pointer}
    .chip{border:1px solid var(--border); border-radius:10px; padding:8px 10px; background:rgba(255,255,255,.06)}

    /* анимированная цитата */
    .quote{
      font-weight:800; font-size:22px;
      background: linear-gradient(90deg,var(--acc1),var(--acc4),var(--acc2));
      -webkit-background-clip:text; background-clip:text; color:transparent;
      animation: shimmer 5s linear infinite;
    }
    @keyframes shimmer{ 0%{filter:saturate(1)} 50%{filter:saturate(1.4)} 100%{filter:saturate(1)} }

    /* -------- Мини-куб (не на весь экран) -------- */
    .cubeWrap{
      display:grid; place-items:center; height: 280px;
    }
    .cubeStage{width: 260px; height: 260px; perspective:1200px}
    .cube{
      width:100%; height:100%; position:relative; transform-style:preserve-3d;
      transition: transform 700ms cubic-bezier(.18,.8,.1,1);
    }
    .face{
      position:absolute; inset:0; display:flex; align-items:center; justify-content:center; gap:10px; flex-direction:column;
      border-radius:18px; border:1px solid var(--border); background: linear-gradient(160deg, rgba(125,211,252,.14), rgba(167,139,250,.12));
      box-shadow: var(--shadow); backface-visibility:hidden; -webkit-backface-visibility:hidden;
    }
    .face .title{font-size:18px; font-weight:800}
    .f-front   { transform: translateZ(130px) }
    .f-back    { transform: rotateY(180deg) translateZ(130px) }
    .f-top     { transform: rotateX(90deg)  translateZ(130px) }
    .f-bottom  { transform: rotateX(-90deg) translateZ(130px) }
    /* показываем верх/низ для вертикального перелистывания между пространствами */
    .cube.ws   { transform: rotateX(0deg) }        /* Workspace сверху */
    .cube.ms   { transform: rotateX(180deg) }      /* Mind Space снизу (переворот по X) */

    .note{font-size:12px; color:var(--muted); text-align:center}
    .ctaRow{display:flex; gap:10px; justify-content:center; flex-wrap:wrap}

    /* -------- Внутренние страницы (рамка) -------- */
    .stack{display:grid; grid-template-rows:auto 1fr; height:100%}
    .cards{display:grid; grid-template-columns:1fr; gap:12px}
    .back{border:1px solid var(--border); background:rgba(255,255,255,.07); color: var(--fg); padding:8px 10px; border-radius:10px; min-height:40px; min-width:40px}
    input, select, textarea{width:100%; padding:10px; border-radius:10px; border:1px solid var(--border); background:rgba(255,255,255,.06); color:var(--fg)}
    .list{display:flex; flex-direction:column; gap:8px; overflow:auto; padding-right:2px; -webkit-overflow-scrolling:touch}
    .task{display:flex; justify-content:space-between; align-items:center; gap:10px; border:1px solid var(--border); border-radius:12px; background:rgba(255,255,255,.05); padding:10px}
    .title{font-weight:800; font-size:18px}
    .meta{color:var(--muted); font-size:12px}
    .pri{padding:2px 6px; border-radius:6px; border:1px solid var(--border); font-size:11px; margin-left:6px}
    .p2{background:rgba(244,114,182,.18); border-color:rgba(244,114,182,.35)} .p1{background:rgba(250,204,21,.18); border-color:rgba(250,204,21,.35)} .p0{background:rgba(52,211,153,.18); border-color:rgba(52,211,153,.35)}
    .done{opacity:.6; text-decoration:line-through}

    /* Календарь (остался компактным) */
    .calendar{display:grid; grid-template-rows:auto auto 1fr; gap:10px; height:100%}
    .cal-grid{display:grid; gap:8px; grid-template-columns:repeat(7,1fr); grid-auto-rows:1fr}
    .dow{text-align:center; font-size:12px; color:var(--muted)}
    .day{border:1px solid var(--border); border-radius:12px; padding:10px; background:rgba(255,255,255,.05)}
    .day .d{font-weight:800} .day.sel{outline:2px solid var(--acc2)} .day.today{outline:2px dashed var(--acc1)}
    .dots{display:flex; gap:4px} .dot{width:6px; height:6px; border-radius:50%; background: var(--acc3); opacity:.85}

    /* Анимации */
    @keyframes fadeIn{from{opacity:0; transform:translateY(8px)} to{opacity:1; transform:none}}
    .fade{animation:fadeIn .28s ease both}
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel" data-presets="env,react">
  const {useState, useEffect, useMemo, useRef} = React;

  /* ---------- helpers ---------- */
  const VERSION="v5";
  const todayISO = () => new Date(Date.now()-new Date().getTimezoneOffset()*60000).toISOString().slice(0,10);
  const go = (hash)=>{ location.hash = hash.startsWith('#') ? hash : '#'+hash; };
  const backTo = (fallback)=>{ if(history.length>1) history.back(); else go(fallback); };
  const S = { get:(k,fall)=>{ try{ return JSON.parse(localStorage.getItem(k)) ?? fall }catch(e){ return fall }}, set:(k,v)=>localStorage.setItem(k,JSON.stringify(v)) };
  const uid = () => Math.random().toString(36).slice(2,10);
  function useRoute(){ const [r,setR]=useState(location.hash.slice(1)||"/"); useEffect(()=>{ const on=()=>setR(location.hash.slice(1)||"/"); if(!location.hash) location.hash="#/"; window.addEventListener("hashchange",on); return ()=>window.removeEventListener("hashchange",on); },[]); return r; }

  /* ---------- keys ---------- */
  const PKEY="sv5_projects", TKEY="sv5_tasks", JKEY="sv5_journal", HKEY="sv5_history";
  const log=(type,payload)=>{ const rec={id:uid(),type,payload,t:Date.now(),v:VERSION}; const arr=S.get(HKEY,[]); arr.unshift(rec); S.set(HKEY,arr); };

  function useTasks(){
    const [projects,setProjects]=useState(()=>S.get(PKEY,[{id:"inbox",name:"Входящие",parentId:null}]));
    const [tasks,setTasks]=useState(()=>S.get(TKEY,[]));
    useEffect(()=>S.set(PKEY,projects),[projects]);
    useEffect(()=>S.set(TKEY,tasks),[tasks]);
    const projMap = useMemo(()=>Object.fromEntries(projects.map(p=>[p.id,p.name])),[projects]);
    return {projects,setProjects,tasks,setTasks,projMap};
  }

  /* ---------- Landing with vertical blocks + mini cube ---------- */
  function Landing(){
    const [showCube,setShowCube]=useState(false);
    const [cubeMode,setCubeMode]=useState('ws'); // 'ws' | 'ms'
    const startY=useRef(null);
    const onTouchStart=(e)=>{startY.current=e.touches[0].clientY};
    const onTouchEnd=(e)=>{ if(startY.current==null) return; const dy=e.changedTouches[0].clientY-startY.current;
      if(cubeMode==='ws' && dy<-50) setCubeMode('ms'); // вверх -> Mind
      if(cubeMode==='ms' && dy>50) setCubeMode('ws');  // вниз -> Workspace
      startY.current=null;
    };
    const enter=()=>{ go(`/spaces/${cubeMode==='ws'?'workspace':'mind'}`); };

    return (
      <div className="frame landing">
        <div className="topbar">
          <div className="brand">Solvo</div>
          <div style={{flex:1}}/><div className="chip">beta {VERSION}</div>
        </div>

        <div className="scroll">
          <section className="section small fade">
            <div className="quote">ищите пути либо оправдания</div>
            <div className="muted" style={{marginTop:6}}>Лаконичность, ясность, движение.</div>
          </section>

          <section className="section small fade">
            <h2 style={{marginBottom:8}}>Начни</h2>
            <div className="ctaRow">
              {!showCube
                ? <button className="btn" onClick={()=>setShowCube(true)}>Начать путешествие</button>
                : <div className="muted">Выбери пространство на кубе ↓</div>}
            </div>
          </section>

          <section className="section medium fade">
            <h3 style={{marginBottom:8}}>Пространства</h3>
            {!showCube
              ? <div className="muted">Нажми «Начать путешествие», чтобы увидеть мини-куб.</div>
              : (
                <div className="cubeWrap" onTouchStart={onTouchStart} onTouchEnd={onTouchEnd}>
                  <div className="cubeStage">
                    <div className={"cube "+(cubeMode==='ws'?'ws':'ms')}>
                      <div className="face f-top">
                        <div className="title">Workspace</div>
                        <div className="muted">проекты • задачи • календарь</div>
                        <button className="btn" onClick={enter}>Открыть</button>
                      </div>
                      <div className="face f-bottom">
                        <div className="title">Mind Space</div>
                        <div className="muted">дневник • настроение • история</div>
                        <button className="btn" onClick={enter}>Открыть</button>
                      </div>
                      <!-- оставим фронт/бэк как подсказки -->
                      <div className="face f-front"><div className="note">Свайпай ↑/↓, чтобы перевернуть</div></div>
                      <div className="face f-back"><div className="note">Свайпай ↑/↓, чтобы перевернуть</div></div>
                    </div>
                  </div>
                </div>
              )
            }
            <div className="note" style={{marginTop:8}}>Мини-куб — это выбор. Само пространство откроется отдельно и аккуратно.</div>
          </section>

          <section className="section small fade">
            <h3>Философия</h3>
            <div className="muted" style={{marginTop:6}}>
              Место, где живут мысль и действие: философ, психолог, планировщик и друг.
              Ничего лишнего — только то, что помогает двигаться.
            </div>
          </section>
        </div>
      </div>
    );
  }

  /* ---------- SPACES (переработанные из v4) ---------- */
  function SpaceDeck({which, subpath}){
    const [showMind,setShowMind]=useState(which==="mind");
    useEffect(()=>setShowMind(which==="mind"),[which]);
    const startY=useRef(null);
    const onTouchStart=(e)=>{startY.current=e.touches[0].clientY};
    const onTouchEnd=(e)=>{ if(startY.current==null) return; const dy=e.changedTouches[0].clientY-startY.current;
      if(!showMind && dy<-60) go('/spaces/mind'+(subpath||''));     // вверх -> Mind
      if(showMind && dy>60)  go('/spaces/workspace'+(subpath||'')); // вниз -> Workspace
      startY.current=null;
    };
    return (
      <div className="frame deck" onTouchStart={onTouchStart} onTouchEnd={onTouchEnd}>
        <div className={"cube "+(showMind?"ms":"ws")} style={{borderRadius:18}}>
          <section className="face f-top"><WorkspaceRouter subpath={subpath||""}/></section>
          <section className="face f-bottom"><MindRouter subpath={subpath||""}/></section>
          <section className="face f-front"></section>
          <section className="face f-back"></section>
        </div>
      </div>
    );
  }

  /* ---------- Workspace pages (с сохранением) ---------- */
  function WorkspaceRouter({subpath}){
    if(!subpath) return <WSHome/>;
    if(subpath.startsWith('/today')) return <TodayPage/>;
    if(subpath.startsWith('/calendar')) return <CalendarPage/>;
    if(subpath.startsWith('/projects')) return <ProjectsPage/>;
    if(subpath.startsWith('/inbox')) return <InboxPage/>;
    if(subpath.startsWith('/project/')) return <ProjectView id={subpath.split('/')[2]}/>;
    return <WSHome/>;
  }

  function WSHome(){
    return (
      <div className="stack fade">
        <div className="topbar">
          <button className="back" onClick={()=>backTo('/')}>←</button>
          <div className="brand">Workspace</div><div style={{flex:1}}/>
          <button className="chip" onClick={()=>go('/spaces/mind')}>Mind ↑</button>
        </div>
        <div className="cards">
          <a className="section" href="#/spaces/workspace/today"><h3>Today</h3><div className="muted">Фокус дня</div></a>
          <a className="section" href="#/spaces/workspace/calendar"><h3>Calendar</h3><div className="muted">Сетка месяца</div></a>
          <a className="section" href="#/spaces/workspace/projects"><h3>Projects</h3><div className="muted">Проекты и под-проекты</div></a>
          <a className="section" href="#/spaces/workspace/inbox"><h3>Inbox</h3><div className="muted">Быстрые заметки</div></a>
        </div>
      </div>
    );
  }

  function TodayPage(){
    const {projects,tasks,setTasks,projMap}=useTasks();
    const [date,setDate]=useState(todayISO());
    const [q,setQ]=useState("");
    const [draft,setDraft]=useState({title:"",projectId:"inbox",pri:1,due:todayISO(),notes:""});
    const add=()=>{ const title=draft.title.trim(); if(!title) return;
      const t={id:uid(),title,projectId:draft.projectId||"inbox",pri:+draft.pri,due:draft.due||todayISO(),notes:draft.notes.trim(),done:false,createdAt:Date.now()};
      setTasks(ts=>[t,...ts]); log('task.add',t); setDraft(d=>({...d,title:"",notes:""}));
    };
    const toggle=(id)=>setTasks(ts=>ts.map(t=>t.id===id?(log('task.toggle',{id,done:!t.done}),{...t,done:!t.done}):t));
    const del=(id)=>setTasks(ts=>{ const t=ts.find(x=>x.id===id); log('task.delete',t); return ts.filter(t=>t.id!==id); });
    const list = useMemo(()=>tasks
      .filter(t=>t.due===date)
      .filter(t=>!q || (t.title+" "+(t.notes||"")).toLowerCase().includes(q.toLowerCase()))
      .sort((a,b)=>(b.pri-a.pri)||(a.done-b.done)||(a.createdAt-b.createdAt)),[tasks,date,q]);

    return (
      <div className="stack fade">
        <div className="topbar">
          <button className="back" onClick={()=>go('/spaces/workspace')}>←</button>
          <div className="brand">Today</div><div style={{flex:1}}/>
          <input type="date" value={date} onChange={e=>setDate(e.target.value)} style={{width:'auto'}}/>
        </div>
        <div className="cards">
          <div className="section">
            <div className="row">
              <input placeholder="Задача" value={draft.title} onInput={e=>setDraft({...draft,title:e.target.value})}/>
              <select value={draft.projectId} onChange={e=>setDraft({...draft,projectId:e.target.value})}>
                {projects.map(p=><option key={p.id} value={p.id}>{p.name}</option>)}
              </select>
              <select value={draft.pri} onChange={e=>setDraft({...draft,pri:e.target.value})}>
                <option value="2">🔥 Высокий</option><option value="1">Средний</option><option value="0">Низкий</option>
              </select>
              <input type="date" value={draft.due} onChange={e=>setDraft({...draft,due:e.target.value})} style={{width:'auto'}}/>
              <button className="btn" onClick={add}>Добавить</button>
            </div>
            <input className="muted" placeholder="Поиск..." value={q} onInput={e=>setQ(e.target.value)} style={{marginTop:8}}/>
          </div>

          <div className="section" style={{minHeight:0}}>
            <div className="list" style={{maxHeight:'58svh'}}>
              {list.length===0 ? <div className="muted">На выбранную дату задач нет.</div> :
                list.map(t=>(
                  <div className={"task "+(t.done?"done":"")} key={t.id}>
                    <div style={{flex:1}}>
                      <div className="title">{t.title}<span className={"pri p"+t.pri}>P{t.pri}</span></div>
                      <div className="meta">{t.notes||"—"} • {projMap[t.projectId]||"Входящие"}</div>
                    </div>
                    <div className="row">
                      <button className="chip" onClick={()=>toggle(t.id)}>{t.done?"Вернуть":"Готово"}</button>
                      <button className="chip" onClick={()=>del(t.id)}>Удалить</button>
                    </div>
                  </div>
                ))
              }
            </div>
          </div>
        </div>
      </div>
    );
  }

  /* Календарь */
  function daysGrid(y,m){ const f=new Date(Date.UTC(y,m,1)); const l=new Date(Date.UTC(y,m+1,0)); const start=(f.getUTCDay()+6)%7; const days=l.getUTCDate(); const g=[]; for(let i=0;i<start;i++) g.push(null); for(let d=1; d<=days; d++) g.push(d); while(g.length%7) g.push(null); return g; }

  function CalendarPage(){
    const {tasks,setTasks}=useTasks();
    const today=todayISO(); const [sel,setSel]=useState(today);
    const [cur,setCur]=useState(()=>{ const d=new Date(); return {y:d.getFullYear(), m:d.getMonth()} });
    const byDay = useMemo(()=>{ const map={}; for(const t of tasks){ (map[t.due]??=[]).push(t); } return map; },[tasks]);
    const next=()=> setCur(c=>({y:c.m===11?c.y+1:c.y, m:(c.m+1)%12}));
    const prev=()=> setCur(c=>({y:c.m===0?c.y-1:c.y, m:(c.m+11)%12}));
    const setToday=()=>{ const d=new Date(); setCur({y:d.getFullYear(), m:d.getMonth()}); setSel(today); };
    const monthISO=(d)=>`${cur.y}-${String(cur.m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    const grid=daysGrid(cur.y,cur.m);

    return (
      <div className="stack fade">
        <div className="topbar">
          <button className="back" onClick={()=>go('/spaces/workspace')}>←</button>
          <div className="brand">Calendar</div><div style={{flex:1}}/>
          <button className="chip" onClick={prev}>‹</button>
          <div className="chip">{new Date(Date.UTC(cur.y,cur.m,1)).toLocaleString('ru-RU',{month:'long',year:'numeric'})}</div>
          <button className="chip" onClick={next}>›</button>
          <button className="chip" onClick={setToday}>Сегодня</button>
        </div>

        <div className="calendar">
          <div className="row muted">Свайп ↑/↓ — смена пространства</div>
          <div className="cal-grid">
            {["Пн","Вт","Ср","Чт","Пт","Сб","Вс"].map(d=><div className="dow" key={d}>{d}</div>)}
            {grid.map((d,i)=>{
              if(d===null) return <div key={"x"+i}></div>;
              const iso=monthISO(d), isToday=iso===today, isSel=iso===sel, dots=(byDay[iso]?.length||0);
              return (
                <div className={"day"+(isToday?" today":"")+(isSel?" sel":"")} key={iso} onClick={()=>setSel(iso)}>
                  <div className="d">{String(d)}</div>
                  <div className="dots">{Array.from({length:Math.min(3,dots)}).map((_,j)=><div className="dot" key={j}></div>)}</div>
                </div>
              );
            })}
          </div>
          <div className="section" style={{display:'flex',gap:8,flexDirection:'column'}}>
            <div className="row">
              <div className="chip">Выбрано: {new Date(sel+"T00:00:00").toLocaleDateString('ru-RU')}</div>
              <div className="muted">Задач: {byDay[sel]?.length||0}</div>
            </div>
            <div className="list" style={{maxHeight:'34svh'}}>
              {(byDay[sel]||[]).map(t=>(
                <div className={"task "+(t.done?"done":"")} key={t.id}>
                  <div style={{flex:1}}>
                    <div className="title">{t.title}<span className={"pri p"+t.pri}>P{t.pri}</span></div>
                    <div className="meta">{t.notes||"—"}</div>
                  </div>
                  <div className="row">
                    <button className="chip" onClick={()=>setTasks(ts=>ts.map(x=>x.id===t.id?{...x,done:!x.done}:x))}>{t.done?"Вернуть":"Готово"}</button>
                  </div>
                </div>
              ))}
              {(!byDay[sel]||byDay[sel].length===0) && <div className="muted">На эту дату пусто.</div>}
            </div>
          </div>
        </div>
      </div>
    );
  }

  function ProjectsPage(){
    const {projects,setProjects,tasks}=useTasks();
    const [name,setName]=useState(""); const [parent,setParent]=useState("root");
    const add=()=>{ const n=name.trim(); if(!n) return; const p={id:uid(),name:n,parentId:(parent=="root"?null:parent)}; setProjects(ps=>[...ps,p]); log('project.add',p); setName(""); };
    const grouped=useMemo(()=>projects.filter(p=>!p.parentId).map(p=>({p,subs:projects.filter(s=>s.parentId===p.id)})),[projects]);
    const count=(id)=>tasks.filter(t=>t.projectId===id).length;
    return (
      <div className="stack fade">
        <div className="topbar">
          <button className="back" onClick={()=>go('/spaces/workspace')}>←</button>
          <div className="brand">Projects</div><div style={{flex:1}}/>
        </div>
        <div className="cards">
          <div className="section">
            <div className="row">
              <input placeholder="Новый проект…" value={name} onInput={e=>setName(e.target.value)}/>
              <select value={parent} onChange={e=>setParent(e.target.value)}>
                <option value="root">Без родителя</option>
                {projects.map(p=><option key={p.id} value={p.id}>{p.name}</option>)}
              </select>
              <button className="btn" onClick={add}>Добавить</button>
            </div>
          </div>
          {grouped.map(({p,subs})=>(
            <div className="section" key={p.id}>
              <div className="row">
                <h3 style={{flex:1}}>{p.name}</h3>
                <a className="chip" href={`#/spaces/workspace/project/${p.id}`}>Открыть</a>
              </div>
              <div className="muted">Задач: {count(p.id)}</div>
              {subs.length>0 && <div className="muted" style={{marginTop:6}}>Под-проекты: {subs.map(s=>s.name).join(", ")}</div>}
            </div>
          ))}
        </div>
      </div>
    );
  }

  function ProjectView({id}){
    const {projects,setProjects,tasks,setTasks}=useTasks();
    const pr = projects.find(p=>p.id===id);
    const [rename,setRename]=useState(pr?.name||"");
    const [taskTitle,setTaskTitle]=useState(""), [notes,setNotes]=useState("");
    const [pri,setPri]=useState(1), [due,setDue]=useState(todayISO());
    useEffect(()=>{ if(pr) setRename(pr.name); },[id]);
    if(!pr) return <div className="stack"><div className="topbar"><button className="back" onClick={()=>go('/spaces/workspace/projects')}>←</button><div>Нет такого проекта</div></div></div>;

    const list = tasks.filter(t=>t.projectId===id).sort((a,b)=>(b.pri-a.pri)||(a.done-b.done)||(a.createdAt-b.createdAt));
    const saveName=()=>{ setProjects(ps=>ps.map(p=>p.id===id? (log('project.rename',{id,from:p.name,to:rename}), {...p,name:rename}) : p)); };
    const addTask=()=>{ const title=taskTitle.trim(); if(!title) return; const t={id:uid(),title,projectId:id,pri:+pri,due,notes:notes.trim(),done:false,createdAt:Date.now()}; setTasks(ts=>[t,...ts]); log('task.add',t); setTaskTitle(""); setNotes(""); };
    const toggle=(tid)=>setTasks(ts=>ts.map(t=>t.id===tid? (log('task.toggle',{id:tid,done:!t.done}), {...t,done:!t.done}) : t));
    const del=(tid)=>setTasks(ts=>{ const t=ts.find(x=>x.id===tid); log('task.delete',t); return ts.filter(t=>t.id!==tid); });
    const delProject=()=>{ if(!confirm("Удалить проект?")) return; log('project.delete',{id,name:pr.name}); setTasks(ts=>ts.filter(t=>t.projectId!==id)); setProjects(ps=>ps.filter(p=>p.id!==id)); go('/spaces/workspace/projects'); };

    return (
      <div className="stack fade">
        <div className="topbar">
          <button className="back" onClick={()=>go('/spaces/workspace/projects')}>←</button>
          <div className="brand">{pr.name}</div><div style={{flex:1}}/>
          <button className="chip" onClick={delProject}>Удалить</button>
        </div>
        <div className="cards">
          <div className="section">
            <div className="row">
              <input value={rename} onInput={e=>setRename(e.target.value)}/>
              <button className="btn" onClick={saveName}>Переименовать</button>
            </div>
          </div>
          <div className="section">
            <div className="row">
              <input placeholder="Новая задача…" value={taskTitle} onInput={e=>setTaskTitle(e.target.value)}/>
              <select value={pri} onChange={e=>setPri(e.target.value)}>
                <option value="2">🔥 Высокий</option><option value="1">Средний</option><option value="0">Низкий</option>
              </select>
              <input type="date" value={due} onChange={e=>setDue(e.target.value)} style={{width:'auto'}}/>
            </div>
            <textarea placeholder="Заметки" value={notes} onInput={e=>setNotes(e.target.value)} style={{marginTop:8}}/>
            <div className="row" style={{marginTop:8}}>
              <button className="btn" onClick={addTask}>Добавить задачу</button>
            </div>
          </div>
          <div className="section" style={{minHeight:0}}>
            <div className="list" style={{maxHeight:'52svh'}}>
              {list.length===0 ? <div className="muted">Пока пусто.</div> :
                list.map(t=>(
                  <div className={"task "+(t.done?"done":"")} key={t.id}>
                    <div style={{flex:1}}>
                      <div className="title">{t.title}<span className={"pri p"+t.pri}>P{t.pri}</span></div>
                      <div className="meta">{t.notes||"—"} • до {t.due}</div>
                    </div>
                    <div className="row">
                      <button className="chip" onClick={()=>toggle(t.id)}>{t.done?"Вернуть":"Готово"}</button>
                      <button className="chip" onClick={()=>del(t.id)}>Удалить</button>
                    </div>
                  </div>
              ))}
            </div>
          </div>
        </div>
      </div>
    );
  }

  function InboxPage(){
    const {tasks,setTasks}=useTasks(); const [text,setText]=useState("");
    const add=()=>{ const t=text.trim(); if(!t) return; const obj={id:uid(),title:t,projectId:"inbox",pri:1,due:todayISO(),notes:"",done:false,createdAt:Date.now()}; setTasks(ts=>[obj,...ts]); log('inbox.add',obj); setText(""); };
    const list = useMemo(()=>tasks.filter(t=>t.projectId==="inbox"),[tasks]);
    const toggle=(id)=>setTasks(ts=>ts.map(t=>t.id===id? (log('task.toggle',{id,done:!t.done}), {...t,done:!t.done}) : t));
    const del=(id)=>setTasks(ts=>{ const t=ts.find(x=>x.id===id); log('task.delete',t); return ts.filter(t=>t.id!==id);});
    return (
      <div className="stack fade">
        <div className="topbar">
          <button className="back" onClick={()=>go('/spaces/workspace')}>←</button>
          <div className="brand">Inbox</div><div style={{flex:1}}/>
        </div>
        <div className="cards">
          <div className="section">
            <div className="row">
              <input placeholder="Быстрая мысль…" value={text} onInput={e=>setText(e.target.value)}/>
              <button className="btn" onClick={add}>Добавить</button>
            </div>
          </div>
          <div className="section" style={{minHeight:0}}>
            <div className="list" style={{maxHeight:'60svh'}}>
              {list.length===0 ? <div className="muted">Пусто.</div> :
                list.map(t=>(
                  <div className={"task "+(t.done?"done":"")} key={t.id}>
                    <div className="title" style={{flex:1}}>{t.title}</div>
                    <div className="row">
                      <button className="chip" onClick={()=>toggle(t.id)}>{t.done?"Вернуть":"Готово"}</button>
                      <button className="chip" onClick={()=>del(t.id)}>Удалить</button>
                    </div>
                  </div>
              ))}
            </div>
          </div>
        </div>
      </div>
    );
  }

  /* ---------- Mind pages ---------- */
  function MindRouter({subpath}){
    if(!subpath) return <MindHome/>;
    if(subpath.startsWith('/journal')) return <JournalPage/>;
    if(subpath.startsWith('/mood')) return <MoodPage/>;
    if(subpath.startsWith('/history')) return <HistoryPage/>;
    return <MindHome/>;
  }

  function MindHome(){
    return (
      <div className="stack fade">
        <div className="topbar">
          <button className="back" onClick={()=>backTo('/')}>←</button>
          <div className="brand">Mind Space</div>
          <div style={{flex:1}}/>
          <button className="chip" onClick={()=>go('/spaces/workspace')}>Workspace ↓</button>
        </div>
        <div className="cards">
          <a className="section" href="#/spaces/mind/journal"><h3>Journal</h3><div className="muted">Утро/вечер, заметки</div></a>
          <a className="section" href="#/spaces/mind/mood"><h3>Mood</h3><div className="muted">Трекинг и график</div></a>
          <a className="section" href="#/spaces/mind/history"><h3>History</h3><div className="muted">События: проекты, задачи, записи</div></a>
        </div>
      </div>
    );
  }

  function JournalPage(){
    const [iso,setIso]=useState(todayISO());
    const [j,setJ]=useState(()=>S.get(JKEY,{}));
    useEffect(()=>S.set(JKEY,j),[j]);
    const get=()=> j[iso] || {m:{focus:"",thanks:"",top3:""}, e:{wins:"",learn:"",mood:3}, notes:""};
    const day=get();
    const setField=(k,v)=>{
      const d=get(), next=JSON.parse(JSON.stringify(d));
      const path=k.split('.'); if(path[0]==='m') next.m[path[1]]=v; else if(path[0]==='e') next.e[path[1]]= path[1]==='mood'? +v : v; else if(k==='notes') next.notes=v;
      const out={...j,[iso]:next}; S.set(JKEY,out); setJ(out); log('journal.edit',{iso,k,v});
    };
    return (
      <div className="stack fade">
        <div className="topbar">
          <button className="back" onClick={()=>go('/spaces/mind')}>←</button>
          <div className="brand">Journal</div>
          <div style={{flex:1}}/>
          <input type="date" value={iso} onChange={e=>setIso(e.target.value)} style={{width:'auto'}}/>
          <button className="chip" onClick={()=>setIso(todayISO())}>Сегодня</button>
        </div>
        <div className="cards">
          <div className="section">
            <h3>Утро</h3>
            <textarea placeholder="Фокус дня" value={day.m.focus} onInput={e=>setField('m.focus',e.target.value)}></textarea>
            <textarea placeholder="Благодарность (3 пункта)" value={day.m.thanks} onInput={e=>setField('m.thanks',e.target.value)}></textarea>
            <textarea placeholder="Топ-3 дела" value={day.m.top3} onInput={e=>setField('m.top3',e.target.value)}></textarea>
          </div>
          <div className="section">
            <h3>Заметки</h3>
            <textarea placeholder="Свободный поток…" value={day.notes} onInput={e=>setField('notes',e.target.value)} style={{height:240}}></textarea>
          </div>
          <div className="section">
            <h3>Вечер</h3>
            <textarea placeholder="Победы" value={day.e.wins} onInput={e=>setField('e.wins',e.target.value)}></textarea>
            <textarea placeholder="Чему научился" value={day.e.learn} onInput={e=>setField('e.learn',e.target.value)}></textarea>
            <div className="row">
              <span className="muted">Настроение</span>
              <input type="range" min="1" max="5" value={day.e.mood} onInput={e=>setField('e.mood',e.target.value)}/>
              <span>{day.e.mood}</span>
            </div>
          </div>
        </div>
      </div>
    );
  }

  /* Mood — живой: эмодзи-чипы + спарклайн + streak */
  function MoodPage(){
    const [j,setJ]=useState(()=>S.get(JKEY,{})); useEffect(()=>S.set(JKEY,j),[j]);
    const iso=todayISO(); const day=j[iso] || {e:{mood:null},m:{},notes:""};
    const setMood=(val)=>{ const cur=j[iso]||{m:{},e:{mood:null},notes:""}; const next={...cur,e:{...(cur.e||{}),mood:val}}; const out={...j,[iso]:next}; S.set(JKEY,out); setJ(out); log('mood.set',{iso,val}); };
    const last=useMemo(()=>{
      const out=[]; const base=new Date(iso+"T00:00:00");
      for(let i=29;i>=0;i--){ const d=new Date(base); d.setDate(d.getDate()-i); const key=new Date(d.getTime()-d.getTimezoneOffset()*60000).toISOString().slice(0,10); out.push({iso:key,mood:j[key]?.e?.mood ?? null}); }
      return out;
    },[j,iso]);
    const streak=useMemo(()=>{ let s=0; for(let i=0;i<999;i++){ const d=new Date(iso+"T00:00:00"); d.setDate(d.getDate()-i); const key=new Date(d.getTime()-d.getTimezoneOffset()*60000).toISOString().slice(0,10); if(j[key]?.e?.mood) s++; else break; } return s; },[j,iso]);
    function Spark({data,w=380,h=80}){ const vals=data.map(d=>d.mood??0); const y=v=>h-(v/5)*h; const step=w/Math.max(1,vals.length-1); let d=""; vals.forEach((v,i)=>{ const x=i*step, yy=y(v||0); d+= (i?` L ${x},${yy}`:`M ${x},${yy}`); }); const fill=d+` L ${w},${h} L 0,${h} Z`; return (<svg width="100%" viewBox={`0 0 ${w} ${h}`} preserveAspectRatio="none"><defs><linearGradient id="g1" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stopColor="#34d399" stopOpacity=".7"/><stop offset="100%" stopColor="#34d399" stopOpacity=".05"/></linearGradient></defs><path d={fill} fill="url(#g1)"/><path d={d} stroke="#34d399" strokeWidth="2" fill="none"/></svg>); }
    const Chip=({val,emoji,label})=>(<button className="chip" onClick={()=>setMood(val)} title={label} style={{fontSize:22}}>{emoji}</button>);
    return (
      <div className="stack fade">
        <div className="topbar">
          <button className="back" onClick={()=>go('/spaces/mind')}>←</button>
          <div className="brand">Mood</div><div style={{flex:1}}/><div className="chip">streak: {streak}</div>
        </div>
        <div className="cards">
          <div className="section">
            <h3>Как ты сегодня?</h3>
            <div className="row" style={{marginTop:8}}>
              <Chip val={1} emoji="😞" label="1 — тяжело"/><Chip val={2} emoji="😕" label="2 — так себе"/><Chip val={3} emoji="😐" label="3 — норм"/><Chip val={4} emoji="🙂" label="4 — хорошо"/><Chip val={5} emoji="😄" label="5 — супер"/>
            </div>
            <div className="muted" style={{marginTop:8}}>Сегодня: {day.e?.mood ?? "—"}</div>
          </div>
          <div className="section">
            <h3>30-дневный график</h3>
            <div style={{marginTop:8}}><Spark data={last}/></div>
            <div className="row" style={{marginTop:8, flexWrap:'wrap'}}>
              {last.slice(-7).map(d=><div className="chip" key={d.iso}>{new Date(d.iso+"T00:00:00").toLocaleDateString('ru-RU',{day:'2-digit',month:'2-digit'})} — {d.mood ?? '—'}</div>)}
            </div>
          </div>
        </div>
      </div>
    );
  }

  function HistoryPage(){
    const [h]=useState(()=>S.get(HKEY,[]));
    return (
      <div className="stack fade">
        <div className="topbar">
          <button className="back" onClick={()=>go('/spaces/mind')}>←</button>
          <div className="brand">History</div><div style={{flex:1}}/>
        </div>
        <div className="cards">
          <div className="section" style={{minHeight:0}}>
            <div className="list" style={{maxHeight:'70svh'}}>
              {h.length===0 ? <div className="muted">История пуста.</div> :
                h.map(e=>(
                  <div className="task" key={e.id}>
                    <div style={{flex:1}}>
                      <div className="title">{e.type}</div>
                      <div className="meta">{new Date(e.t).toLocaleString()} • {JSON.stringify(e.payload)}</div>
                    </div>
                  </div>
              ))}
            </div>
          </div>
        </div>
      </div>
    );
  }

  /* ---------- Router ---------- */
  function App(){
    const r = useRoute(); // "/", "/spaces/workspace[/...]", "/spaces/mind[/...]"
    if(r==="/") return <Landing/>;
    if(r.startsWith("/spaces")){
      const parts = r.split("/").slice(2);
      const which = parts[0] || "workspace";
      const subpath = "/"+(parts[1]||"") + (parts[2]?"/"+parts[2]:"");
      return <SpaceDeck which={which} subpath={subpath==="/"? "" : subpath}/>;
    }
    return <Landing/>;
  }
  ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
  </script>
</body>
</html>
